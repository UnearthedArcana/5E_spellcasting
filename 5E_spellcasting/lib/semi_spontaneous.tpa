
// v5.7 - universal


/*
the way it works: 
- d5zprp gives access to spellbook, disables casting, and sets prep spellstate
- zz000 is applied in CLAB table;
 -- sets fatigue to 1 and c
 -- permanently sets repeating spell, zlots
- zlots checks for NO semi state, then casts zzini
 -- zzini does all initialization stuff:
  --- sets semi state (several 177s checking for class)
  --- casts z0slt
  --- casts z206
  --- casts znoqk
  --- 206 vs. zz000
  --- casts zprpb
  --- gives zprp
  --- sets fatigue to 0 after 6 second delay
- zlots checks for fatigue = 0, then casts zlotf
- if no prep state, zlotf casts zrfrsh
 -- zrfrsh removes spellbook access, casts zsplz
- if yes prep state, zlotf casts zlotr
 -- zlotr summons zlotr.cre
 -- zlotr.cre runs zlotr.bcs
 -- zlotr.bcs gives chosen spells and casts zprpd
 -- zprpd restores spellcasting, casts zsplz
- zsplz gives innate spells according to your casting slots
*/


DEFINE_ACTION_FUNCTION semi_spontaneous_casting INT_VAR include_arcane = 0 include_divine = 0 BEGIN


ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__semi_spont.d5~) BEGIN


//disable quickspell buttons__________________________________________________________
//
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5znoqk.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 144 target = 1 parameter2 = 3 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 144 target = 1 parameter2 = 4 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 144 target = 1 parameter2 = 5 timing = 9 END


//semi spont spellstates______________________________________________________________
//
ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_SEMI_ARCANE~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_SEMI_ARCANE~) BEGIN
		SET semi_spont_arcane = %state_ind%
	  END
	END
  BUT_ONLY
END

ACTION_IF !(VARIABLE_IS_SET %semi_spont_arcane%) BEGIN
  LAF d5_resolve_state STR_VAR new_state_id = ~D5_SEMI_ARCANE~ RET new_state_ind END
  OUTER_SET semi_spont_arcane = %new_state_ind%
END

ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_SEMI_DIVINE~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_SEMI_DIVINE~) BEGIN
		SET semi_spont_divine = %state_ind%
	  END
	END
  BUT_ONLY
END

ACTION_IF !(VARIABLE_IS_SET %semi_spont_divine%) BEGIN
  LAF d5_resolve_state STR_VAR new_state_id = ~D5_SEMI_DIVINE~ RET new_state_ind END
  OUTER_SET semi_spont_divine = %new_state_ind%
END


//prepared spells spellstate__________________________________________________________
//
ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_SPL_PREP~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_SPL_PREP~) BEGIN
		SET prepared_spells_state = %state_ind%
	  END
	END
  BUT_ONLY
END

ACTION_IF !(VARIABLE_IS_SET %prepared_spells_state%) BEGIN
  LAF d5_resolve_state STR_VAR new_state_id = ~D5_SPL_PREP~ RET new_state_ind END
  OUTER_SET prepared_spells_state = %new_state_ind%
END


//add spell slot stat checks to SPLPROT______________________________________________
//
APPEND ~splprot.2da~ ~D5_WIZ_1_7%TAB%108%TAB%-1%TAB%7~ UNLESS ~D5_WIZ_1_7~
APPEND ~splprot.2da~ ~D5_WIZ=1_7%TAB%108%TAB%-1%TAB%8~ UNLESS ~D5_WIZ=1_7~
APPEND ~splprot.2da~ ~D5_WIZ_8_9%TAB%109%TAB%-1%TAB%7~ UNLESS ~D5_WIZ_8_9~
APPEND ~splprot.2da~ ~D5_WIZ=8_9%TAB%109%TAB%-1%TAB%8~ UNLESS ~D5_WIZ=8_9~
APPEND ~splprot.2da~ ~D5_DIV_1_7%TAB%134%TAB%-1%TAB%7~ UNLESS ~D5_DIV_1_7~
APPEND ~splprot.2da~ ~D5_DIV=1_7%TAB%134%TAB%-1%TAB%8~ UNLESS ~D5_DIV=1_7~
APPEND ~splprot.2da~ ~D5_FATIGUE_0%TAB%30%TAB%0%TAB%1~ UNLESS ~D5_FATIGUE_0~
APPEND ~splprot.2da~ ~D5_PREP_SPLZ%TAB%0x112%TAB%%prepared_spells_state%%TAB%1~ UNLESS ~D5_PREP_SPLZ~
APPEND ~splprot.2da~ ~D5_NOT_PREP%TAB%0x112%TAB%%prepared_spells_state%%TAB%5~ UNLESS ~D5_NOT_PREP~
APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~

COPY_EXISTING ~splprot.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW rows cols
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ_1_7~) BEGIN
	  SET fake_sorc_slots_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ=1_7~) BEGIN
	  SET fake_sorc_equal_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ_8_9~) BEGIN
	  SET fake_sorc_slots_8_9 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ=8_9~) BEGIN
	  SET fake_sorc_equal_8_9 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_DIV_1_7~) BEGIN
	  SET fake_sham_slots_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_DIV=1_7~) BEGIN
	  SET fake_sham_equal_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_FATIGUE_0~) BEGIN
	  SET fatigue_zero = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_PREP_SPLZ~) BEGIN
	  SET prep_spells_row = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_NOT_PREP~) BEGIN
	  SET not_prep_row = %row%
	END
	PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	  SET kit_is_row = %row%
	END
  END
BUT_ONLY


//remove all mage spell slots_________________________________________________________
//
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z17wz.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 42 target = 1 parameter1 = (0 - 1) parameter2 = 127 timing = 9 END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z89wz.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 42 target = 1 parameter1 = (0 - 1) parameter2 = 384 timing = 9 END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z17dv.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 62 target = 1 parameter1 = (0 - 1) parameter2 = 127 timing = 9 END

// this is for... what? to eliminate kitted mage bonus slots?
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z0slt.spl~ 
  PATCH_IF (MOD_IS_INSTALLED ~TomeAndBlood.tp2~ ~62~) BEGIN	//	level 1 cantrips
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 42 target = 1 parameter1 = (0 - 1) parameter2 = 510 /*126*/ timing = 9 END // should cover lvl 8-9 spls too
  END
  PATCH_IF !(MOD_IS_INSTALLED ~TomeAndBlood.tp2~ ~62~) BEGIN	//	level 1 cantrips
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 42 target = 1 parameter1 = (0 - 1) parameter2 = 511 /*127*/ timing = 9 END // should cover lvl 8-9 spls too
  END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5z0slt~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 318 target = 1 parameter1 = 0 parameter2 = %kit_is_row% timing = 0 duration = 1 STR_VAR resource = ~d5z0slt~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 318 target = 1 parameter1 = 16384 parameter2 = %kit_is_row% timing = 0 duration = 1  STR_VAR resource = ~d5z0slt~ END


/* I think this is only applied once, no need for 2nd copy
COPY_EXISTING ~d5z0slt.spl~ ~override/d5z1slt.spl~
  LPF ALTER_EFFECT INT_VAR match_opcode = 321 STR_VAR match_resource = ~d500slt~ resource = ~d501slt~ END
*/

// what is this one vv for...?  L1Cantrips
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z2slt.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 42 parameter1 = (0 - 1) parameter2 = 2 target = 1 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5z2slt~ END

// here are spells for use with TnB/SoB abil score bonus slots
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zislt.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 42 target = 1 parameter1 = (0 - 1) parameter2 = 127 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5zislt~ END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zjslt.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 42 target = 1 parameter1 = (0 - 1) parameter2 = 127 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5zjslt~ END


//create advance copies of some spells________________________________________________
//
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zz206.spl~

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zz172.spl~

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zz145.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 145 target = 1 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 145 target = 1 parameter2 = 1 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5zspld~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5zspla~ END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z0spl.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = EVAL ~SPWI908~ END
  PATCH_IF !(MOD_IS_INSTALLED ~TomeAndBlood.tp2~ ~16~) BEGIN
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~SPWI110~ END
  END
  PATCH_IF !(MOD_IS_INSTALLED ~TomeAndBlood.tp2~ ~55~) BEGIN
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = EVAL ~SPWI420~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = EVAL ~SPWI710~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = EVAL ~SPWI809~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = EVAL ~SPWI617~ END
  END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot1a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot1b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot1c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot1d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot2a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot2b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot2c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot2d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot3a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot3b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot3c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot3d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot4a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot4b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot4c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot4d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot5a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot5b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot5c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot5d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot6a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot6b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot6c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot6d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot7a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot7b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot7c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot7d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot8a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot8b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot8c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot8d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot9a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot9b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot9c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwot9d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot1a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot1b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot1c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot1d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot2a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot2b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot2c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot2d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot3a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot3b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot3c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot3d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot4a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot4b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot4c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot4d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot5a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot5b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot5c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot5d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot6a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot6b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot6c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot6d.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot7a.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot7b.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot7c.spl~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zdot7d.spl~

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zspld.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 4) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot1a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 4) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot1b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 4) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot1c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 4) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot1d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 8) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot2a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 8) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot2b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 8) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot2c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 8) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot2d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 12) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot3a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 12) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot3b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 12) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot3c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 12) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot3d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 16) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot4a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 16) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot4b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 16) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot4c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 16) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot4d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 20) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot5a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 20) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot5b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 20) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot5c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 20) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot5d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 24) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot6a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 24) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot6b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 24) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot6c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 24) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot6d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 28) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot7a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 28) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot7b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 28) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot7c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 28) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5zdot7d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 1 STR_VAR resource = ~d5zspld~ END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zspla.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 4) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot1a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 4) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot1b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 4) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot1c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 4) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot1d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 8) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot2a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 8) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot2b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 8) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot2c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 8) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot2d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 12) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot3a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 12) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot3b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 12) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot3c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 12) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot3d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 16) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot4a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 16) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot4b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 16) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot4c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 16) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot4d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 20) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot5a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 20) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot5b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 20) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot5c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 20) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot5d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 24) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot6a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 24) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot6b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 24) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot6c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 24) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot6d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 28) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot7a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 28) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot7b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 28) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot7c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 28) parameter2 = %fake_sorc_slots_1_7% timing = 1 STR_VAR resource = ~d5zwot7d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 24) parameter2 = %fake_sorc_slots_8_9% timing = 1 STR_VAR resource = ~d5zwot8a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 24) parameter2 = %fake_sorc_slots_8_9% timing = 1 STR_VAR resource = ~d5zwot8b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 24) parameter2 = %fake_sorc_slots_8_9% timing = 1 STR_VAR resource = ~d5zwot8c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 24) parameter2 = %fake_sorc_slots_8_9% timing = 1 STR_VAR resource = ~d5zwot8d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 28) parameter2 = %fake_sorc_slots_8_9% timing = 1 STR_VAR resource = ~d5zwot9a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 28) parameter2 = %fake_sorc_slots_8_9% timing = 1 STR_VAR resource = ~d5zwot9b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 28) parameter2 = %fake_sorc_slots_8_9% timing = 1 STR_VAR resource = ~d5zwot9c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 28) parameter2 = %fake_sorc_slots_8_9% timing = 1 STR_VAR resource = ~d5zwot9d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 1 STR_VAR resource = ~d5zspla~ END

//assign stats for spell slots to each spell level____________________________________
//
// arcane level 1 = 	108 << 4
// arcane level 2 = 	108 << 8
// arcane level 3 = 	108 << 12
// arcane level 4 = 	108 << 16
// arcane level 5 = 	108 << 20
// arcane level 6 = 	108 << 24
// arcane level 7 = 	108 << 28
// arcane level 8 = 	109 << 24
// arcane level 9 = 	109 << 28
// divine level 1 = 	134 << 4
// divine level 2 = 	134 << 8
// divine level 3 = 	134 << 12
// divine level 4 = 	134 << 16
// divine level 5 = 	134 << 20
// divine level 6 = 	134 << 24
// divine level 7 = 	134 << 28
//

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src1a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src1%let%.spl~
	  SAY NAME1 @21991
	  SAY UNIDENTIFIED_DESC @21991
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (108 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5src1%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src2a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src2%let%.spl~
	  SAY NAME1 @21992
	  SAY UNIDENTIFIED_DESC @21992
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (108 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5src2%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src3a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src3%let%.spl~
	  SAY NAME1 @21993
	  SAY UNIDENTIFIED_DESC @21993
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (108 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5src3%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src4a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src4%let%.spl~
	  SAY NAME1 @21994
	  SAY UNIDENTIFIED_DESC @21994
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (108 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5src4%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src5a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src5%let%.spl~
	  SAY NAME1 @21995
	  SAY UNIDENTIFIED_DESC @21995
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (108 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5src5%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src6a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src6%let%.spl~
	  SAY NAME1 @21996
	  SAY UNIDENTIFIED_DESC @21996
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (108 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5src6%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src7a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src7%let%.spl~
	  SAY NAME1 @21997
	  SAY UNIDENTIFIED_DESC @21997
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (108 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5src7%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src8a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src8%let%.spl~
	  SAY NAME1 @21989
	  SAY UNIDENTIFIED_DESC @21989
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (109 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5src8%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src9a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src9%let%.spl~
	  SAY NAME1 @21990
	  SAY UNIDENTIFIED_DESC @21990
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (109 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5src9%let%~ END
  END
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm1a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm1%let%.spl~
	  SAY NAME1 @21991
	  SAY UNIDENTIFIED_DESC @21991
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm1%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm2a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm2%let%.spl~
	  SAY NAME1 @21992
	  SAY UNIDENTIFIED_DESC @21992
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm2%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm3a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm3%let%.spl~
	  SAY NAME1 @21993
	  SAY UNIDENTIFIED_DESC @21993
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm3%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm4a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm4%let%.spl~
	  SAY NAME1 @21994
	  SAY UNIDENTIFIED_DESC @21994
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm4%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm5a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm5%let%.spl~
	  SAY NAME1 @21995
	  SAY UNIDENTIFIED_DESC @21995
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm5%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm6a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm6%let%.spl~
	  SAY NAME1 @21996
	  SAY UNIDENTIFIED_DESC @21996
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm6%let%~ END
  END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm7a.spl~) BEGIN
  ACTION_FOR_EACH let IN ~a~ BEGIN
	COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm7%let%.spl~
	  SAY NAME1 @21997
	  SAY UNIDENTIFIED_DESC @21997
	  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~spcl919b~ END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm7%let%~ END
  END
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src-1.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src-1.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 4) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src-2.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src-2.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 8) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src-3.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src-3.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 12) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src-4.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src-4.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 16) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src-5.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src-5.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 20) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src-6.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src-6.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 24) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src-7.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src-7.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 28) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src-8.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src-8.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 24) parameter2 = (109 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5src-9.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5src-9.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 28) parameter2 = (109 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm-1.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm-1.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 4) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm-2.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm-2.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 8) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm-3.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm-3.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 12) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm-4.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm-4.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 16) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm-5.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm-5.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 20) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm-6.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm-6.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 24) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shm-7.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5shm-7.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 28) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END


// 'prepare spells' spell_____________________________________________________________
//
OUTER_SET prep_message = RESOLVE_STR_REF(~Memorized spells may be now changed. Spellcasting is disabled until the next full rest.~)
COPY ~%MOD_FOLDER%/lib/semi_spont/d5zwtch.bam~ ~override~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5zprep.bam~ ~override~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5zgren.bam~ ~override~
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zprp.spl~
  SAY NAME1 ~Change Prepared Spells~
  SAY UNIDENTIFIED_DESC ~Spell Preparation

This ability allows the you to prepare a new set of spells for the next day. Upon using the ability, preparation slots will become available in your spellbook, and spellcasting will be disabled. After filling any available preparation slots, you must rest for 8 hours. Upon waking, spellcasting will be re-enabled, and you will be unable to modify the contents of your preparation slots until the next time this ability is used.
~
  WRITE_ASCII 0x3a ~d5zgren~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5zgren~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5z17wz~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5z89wz~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5z17dv~ END
//  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5zz145~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5zz206~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5zprp1~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 139 target = 1 parameter1 = %prep_message% timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 duration = 0 STR_VAR resource = ~d5zz172~ END

/*
// ***** what is this vv for??  -  answer: game-start initialization  -  edit - not really though
COPY_EXISTING ~d5zprp.spl~ ~override/d5zprpb.spl~
  LPF DELETE_EFFECT INT_VAR match_opcode = 139 END
*/

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zprp1.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 328 target = 1 special = 1 parameter2 = %prepared_spells_state% timing = 9 END


//daily spell slot refresh____________________________________________________________
//
COPY ~%MOD_FOLDER%/lib/semi_spont/d5zcast.bam~ ~override~

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zlotz.spl~
  SAY NAME1 ~initialize 5E spellcasting~
  SAY UNIDENTIFIED_DESC ~initialize 5E spellcasting~
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5zcast~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = ~d5zlots~ END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zlots.eff~) BEGIN
  CREATE EFF ~d5zlots~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_ASCII 0x30 ~d5zlots~ #8
	WRITE_LONG 0x48 102
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zlots.spl~) BEGIN
  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zlots.spl~
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 111 timing = 1 STR_VAR resource = ~d5zz001~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0 parameter2 = %fatigue_zero% timing = 1 STR_VAR resource = ~d5zlotf~ END
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zlotf.spl~) BEGIN
  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zlotf.spl~
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 111 timing = 1 STR_VAR resource = ~d5zz010~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 111 timing = 1 STR_VAR resource = ~d5zz020~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0 parameter2 = %prep_spells_row% timing = 1 STR_VAR resource = ~d5zlotr~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0 parameter2 = %not_prep_row% timing = 1 STR_VAR resource = ~d5zrfrsh~ END
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zlotr.spl~) BEGIN
  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zlotr.spl~
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 12 STR_VAR resource = ~d5zlotr~ END
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zlotr.eff~) BEGIN
  CREATE EFF ~d5zlotr~
	WRITE_LONG 0x10 67
	WRITE_LONG 0x14 1
	WRITE_LONG 0x28 12
	WRITE_SHORT 0x2c 100
	WRITE_ASCII 0x30 ~d5zlotr~ #8
	WRITE_ASCII 0x70 ~shskull~ #8
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zlotr.cre~) BEGIN
  COPY ~%MOD_FOLDER%/lib/semi_spont/d5zlotr.cre~ ~override~
	WRITE_ASCII 0x248 ~D5ZLOTR~ #8
END


// spell to simply refresh spell slots________________________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zrfrsh.spl~) BEGIN
  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zrfrsh.spl~
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 93 target = 1 parameter1 = 1 parameter2 = 1 timing = 1 END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5zz145~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5src-1~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5src-2~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5src-3~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5src-4~ END
  	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5src-5~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5src-6~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5src-7~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5src-8~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5src-9~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5shm-1~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5shm-2~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5shm-3~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5shm-4~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5shm-5~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5shm-6~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5shm-7~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 duration = 0 STR_VAR resource = ~d5zz172~ END
//	LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5zsplz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1  STR_VAR resource = ~d5zspla~ END
END


// spell to set prepped spells and refresh slots______________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zprpd.spl~) BEGIN
  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zprpd.spl~
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 93 target = 1 parameter1 = 1 parameter2 = 1 timing = 1 END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17dv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z17wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z89wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z89wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z89wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z89wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z89wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z89wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z89wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z89wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z89wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = ~d5z89wz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5zprp1~ END
//    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5zz145~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5src-1~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5src-2~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5src-3~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5src-4~ END
  	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5src-5~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5src-6~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5src-7~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5src-8~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5src-9~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-1~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-2~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-3~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-4~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-5~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-6~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-7~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 279 target = 1 parameter2 = 2 timing = 9 END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 duration = 0 STR_VAR resource = ~d5zz172~ END
//	LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5zsplz~ END
//	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
//	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1  STR_VAR resource = ~d5zspla~ END
END


// 5E system initialization___________________________________________________________
//
// put this zz000 in the clab tables
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zz000.spl~) BEGIN
  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zz000.spl~
    SAY NAME1 ~initialize 5E spellcasting~
    SAY UNIDENTIFIED_DESC ~initialize 5E spellcasting~
    LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5zcast~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 93 target = 1 parameter1 = 1 parameter2 = 1 timing = 1 END
//  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5zlotz~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = ~d5zlots~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 318 target = 1 parameter1 = 19 parameter2 = 105 timing = 9 STR_VAR resource = ~d5zz000~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 318 target = 1 parameter1 = 2 parameter2 = 112 timing = 9 STR_VAR resource = ~d5zz000~ END
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zz001.spl~) BEGIN
  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zz001.spl~
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 111 timing = 1 STR_VAR resource = ~d5zzini~ END
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zzini.spl~) BEGIN
  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zzini.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 1 parameter2 = 105 timing = 1 STR_VAR resource = ~d5z0slt~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5zz206~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5znoqk~ END
//  PATCH_IF (MOD_IS_INSTALLED ~tomeandblood.tp2~ ~62~) BEGIN
//    LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5z2slt~ END
//  END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5zz000~ END
//  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5zprpb~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5zprp1~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5zprp~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 93 target = 1 parameter1 = 0 parameter2 = 1 timing = 4 duration = 4 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5zzini~ END
END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zz010.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 3 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zsttd~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 6 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zsttd~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 8 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zsttd~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 11 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zsttd~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 12 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zsttd~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 14 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zsttd~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 15 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zsttd~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 16 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zsttd~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 17 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zsttd~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 18 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zsttd~ END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zz020.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 1 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zstta~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 5 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zstta~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 7 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zstta~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 10 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zstta~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 13 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zstta~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 14 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zstta~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 17 parameter2 = 105 timing = 1 STR_VAR resource = ~d5zstta~ END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zsttd.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 328 target = 1 special = 1 parameter2 = %semi_spont_divine% timing = 9 END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zstta.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 328 target = 1 special = 1 parameter2 = %semi_spont_arcane% timing = 9 END


// generate zclons.2da________________________________________________________________
//
<<<<<<<< d5/d5zclons.2da
2DA V1.0 
IND
		MEM 	CAST 		TYPE 	PROCESSED
100		#		#			#		#
>>>>>>>> 

COPY ~d5/d5zclons.2da~ ~override/d5zclons.2da~ 

// 206/blocking spell = d5zb[ind]
// 171/granting .eff  = d5ze[ind]
// 321/learning spell = d5zl[ind]
// 146/innate spell   = d5zi[ind]


//remove wiz bonus slots______________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5absp1.spl~) BEGIN
  COPY_EXISTING ~d5absp1.spl~ ~override~
    LPF DELETE_EFFECT INT_VAR match_opcode = 177 STR_VAR match_resource = ~d5abspw~ END
  BUT_ONLY
END

ACTION_IF (FILE_EXISTS_IN_GAME ~d5abspw.spl~) BEGIN
  COPY_EXISTING ~d5abspw.spl~ ~override~
    LPF DELETE_EFFECT END
  BUT_ONLY
END

//fix burning hands targeting_______________________________________________________
//
COPY_EXISTING ~spwi103.spl~ ~override~
  READ_LONG 0x08 burning_hands_strref
BUT_ONLY

ACTION_IF (IS_AN_INT %burning_hands_strref%) BEGIN
  COPY_EXISTING_REGEXP GLOB ~^.+\.spl$~ ~override~
	PATCH_IF (%SOURCE_SIZE% > 0x71) BEGIN
	  SET burning_change = 0
	  READ_LONG 0x08 name
	  PATCH_IF (name = burning_hands_strref) BEGIN
		GET_OFFSET_ARRAY ab_array SPL_V10_HEADERS
		PHP_EACH ab_array AS int => ab_off BEGIN
		  PATCH_IF (burning_change = 0) BEGIN
			READ_BYTE (ab_off + 0x0c) target
			PATCH_IF target = 5 BEGIN
			  SET burning_change = 1
			END
		  END
		END
		PATCH_IF (burning_change = 1) BEGIN
		  LPF ALTER_SPELL_HEADER INT_VAR target = 1 END
		  LPF ALTER_EFFECT INT_VAR match_opcode = 148 opcode = 146 target = 2 STR_VAR match_resource = ~spwi103~ END
		  WRITE_BYTE 0x1b (THIS BOR 1)
		END
	  END
	END
  BUT_ONLY
END


//fix black pits 2___________________________________________________________________
//
COPY_EXISTING ~ohbantim.spl~ override
  LPF ALTER_EFFECT INT_VAR match_opcode = 144 match_parameter2 = 13 opcode = 145 parameter2 = 3 END
IF_EXISTS BUT_ONLY

// change BP1 to allow innates too
// EDIT - don't need to!

//____________________________________________________________________________________


COPY ~%MOD_FOLDER%/lib/semi_spont/d5_marker.d5~ ~override/d5__semi_spont.d5~


END		//	end marker file check


ACTION_IF (include_divine = 1) BEGIN
  LAF semi_divine_spells END
END

ACTION_IF (include_arcane = 1) BEGIN
  LAF semi_arcane_spells END
END

LAF process_semi_spells END


END		//	end define function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_ACTION_FUNCTION process_semi_spells BEGIN

ACTION_IF (FILE_EXISTS_IN_GAME ~5E_casting_settings.ini~) BEGIN
  	INCLUDE ~override/5E_casting_settings.ini~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~5E_casting_settings.ini~) BEGIN
  	INCLUDE ~%MOD_FOLDER%/lib/semi_spont/5E_casting_settings.ini~
END

LAM 5E_casting_settings

ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_SEMI_ARCANE~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_SEMI_ARCANE~) BEGIN
		SET semi_spont_arcane = %state_ind%
	  END
	END
  BUT_ONLY
END

ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_SEMI_DIVINE~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_SEMI_DIVINE~) BEGIN
		SET semi_spont_divine = %state_ind%
	  END
	END
  BUT_ONLY
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5zlotr.bcs~) BEGIN
<<<<<<<<d5/inline_script.baf
>>>>>>>>

  COPY ~d5/inline_script.baf~ ~weidu_external/d5_semi_cast/d5zlotr.baf~

<<<<<<<<d5/inline_script_end.baf
IF
	True()
THEN
	RESPONSE #100
	ActionOverride(LastSummonerOf(Myself),ApplySpellRes("D5ZPRPD",Myself))
	DestroySelf() 
END
>>>>>>>>

  COPY ~d5/inline_script_end.baf~ ~weidu_external/d5_semi_cast/d5z_end.baf~

END

COPY_EXISTING ~d5zclons.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW ~r2en_zclons~ cols
  FOR (row = 0; row < r2en_zclons; ++row) BEGIN
    READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 0 z_ind
    READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 1 mem_spell
    READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 2 cast_spell
    READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 3 spell_type
    READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 4 spell_proc
    SPRINT innate_spell ~d5z%z_ind%i~
    SPRINT give_spell ~d5z%z_ind%g~
    SPRINT block_spell ~d5z%z_ind%b~
    SPRINT learn_spell ~d5z%z_ind%l~
    PATCH_IF (z_ind > 100) AND (~%spell_proc%~ STRING_EQUAL_CASE ~no~) BEGIN
      INNER_ACTION BEGIN
        COPY_EXISTING ~%mem_spell%.spl~ ~override~
          READ_LONG 0x34 level
        IF_EXISTS BUT_ONLY
// create innate spell
		COPY_EXISTING ~%cast_spell%.spl~ ~override/%innate_spell%.spl~
		  WRITE_SHORT 0x1c 4
		  LPF ALTER_SPELL_HEADER INT_VAR location = 2 END
		  READ_LONG 0x64 abil_offset
		  READ_SHORT 0x68 abil_number
		  READ_BYTE (%abil_offset% + 0x0c) abil_target					
		  READ_SHORT (%abil_offset% + 0x0e) abil_range
		  READ_LONG 0x6a eff_offset
		  WHILE (%abil_number% > 0) BEGIN
			SET abil_number = (%abil_number% - 1)
			WRITE_SHORT (%abil_offset% + 0x26 + (0x28 * %abil_number%)) 1
		  END
		  READ_BYTE (%eff_offset% + 0x02) eff_target
		  LPF DELETE_EFFECT INT_VAR match_probability2 = 0 END
		  PATCH_IF (%abil_target% = 4) BEGIN
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 148 target = 1 power = 0 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%cast_spell%~ END
			PATCH_IF (%abil_range% < 35) BEGIN
			  PATCH_IF (%abil_range% > 4) BEGIN
				LPF ALTER_SPELL_HEADER INT_VAR range = (%abil_range% - 3) END
			  END
			  PATCH_IF (%abil_range% < 5) BEGIN
			 	LPF ALTER_SPELL_HEADER INT_VAR target = 5 END	// might need to carve out exceptions, e.g. burning hands
			  END
			END
		  END
		  ELSE BEGIN
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 2 power = 0 parameter2 = 1 timing = 9 STR_VAR resource = EVAL ~%cast_spell%~ END
		  END
// exempt lvl 1 if lv1 1 cantrips
		  PATCH_IF (~%spell_type%~ STRING_EQUAL_CASE ~arcane~) BEGIN
		    PATCH_IF (MOD_IS_INSTALLED ~tomeandblood.tp2~ ~62~) BEGIN
		      PATCH_IF (%level% > 1) BEGIN
				LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5src-%level%~ END
		      END
		    END
		    PATCH_IF !(MOD_IS_INSTALLED ~tomeandblood.tp2~ ~62~) BEGIN
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5src-%level%~ END
		    END
		  END
		  PATCH_IF (~%spell_type%~ STRING_EQUAL_CASE ~divine~) BEGIN
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5shm-%level%~ END
		  END
		  PATCH_IF (lose_spell_on_interrupt = 0) BEGIN
		    LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1  STR_VAR resource = ~d5zspla~ END
		  END
		  PATCH_IF (lose_spell_on_interrupt = 1) BEGIN
		    LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
			LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
			LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1  STR_VAR resource = ~d5zspla~ END
		  END
// make spells adding the innate spell
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/%give_spell%.spl~
          LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = EVAL ~%innate_spell%~ END
// make 206 spells preventing the add spell
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/%block_spell%.spl~
		  WRITE_SHORT 0x1c 4
	  	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~%give_spell%~ END
// add 206 spells to CLAB spell
	    COPY_EXISTING ~d5zz206.spl~ ~override~
	      LPF DELETE_EFFECT INT_VAR match_opcode = 146 STR_VAR match_resource = EVAL ~%block_spell%~ END
	      LPF DELETE_EFFECT INT_VAR match_opcode = 321 STR_VAR match_resource = EVAL ~%block_spell%~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%block_spell%~ END
	  	  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~%block_spell%~ END
// make learn spells canceling the 206
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/%learn_spell%.spl~
	  	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~%block_spell%~ END
//		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~%block_spell%~ END
// add 172 to zz172
	    COPY_EXISTING ~d5zz172.spl~ ~override~
		  LPF ADD_SPELL_EFFECT INT_VAR /*insert_point = 0*/ opcode = 172 target = 1 timing = 9 STR_VAR resource = EVAL ~%innate_spell%~ END
// generate slot#x spells
	    ACTION_IF (~%spell_type%~ STRING_EQUAL_CASE ~arcane~) BEGIN
		  ACTION_IF (FILE_EXISTS_IN_GAME ~d5zwot%level%a.spl~) BEGIN
			COPY_EXISTING ~d5zwot%level%a.spl~ ~override~
		      LPF DELETE_EFFECT INT_VAR match_opcode = 146 STR_VAR match_resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			COPY_EXISTING ~d5zwot%level%b.spl~ ~override~
		      LPF DELETE_EFFECT INT_VAR match_opcode = 146 STR_VAR match_resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			COPY_EXISTING ~d5zwot%level%c.spl~ ~override~
		      LPF DELETE_EFFECT INT_VAR match_opcode = 146 STR_VAR match_resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			COPY_EXISTING ~d5zwot%level%d.spl~ ~override~
		      LPF DELETE_EFFECT INT_VAR match_opcode = 146 STR_VAR match_resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
		  END
		END
	    ACTION_IF (~%spell_type%~ STRING_EQUAL_CASE ~divine~) BEGIN
		  ACTION_IF (FILE_EXISTS_IN_GAME ~d5zdot%level%a.spl~) BEGIN
			COPY_EXISTING ~d5zdot%level%a.spl~ ~override~
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			COPY_EXISTING ~d5zdot%level%b.spl~ ~override~
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			COPY_EXISTING ~d5zdot%level%c.spl~ ~override~
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			COPY_EXISTING ~d5zdot%level%d.spl~ ~override~
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
			  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%give_spell%~ END
		  END
		END
        APPEND_OUTER ~weidu_external/d5_semi_cast/d5zlotr.baf~ ~
IF
    TriggerOverride(LastSummonerOf(Myself),HaveSpellRES("%mem_spell%"))
THEN
    RESPONSE #100
    ActionOverride(LastSummonerOf(Myself),ApplySpellRes("%learn_spell%",Myself))
    Continue()
END
~
      END
      SET_2DA_ENTRY row 4 cols ~yes~
    END
  END
BUT_ONLY


// compile script_____________________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5zlotr.bcs~) BEGIN
  DELETE ~override/d5zlotr.bcs~
END

COMPILE ~weidu_external/d5_semi_cast/d5zlotr.baf~

EXTEND_BOTTOM ~d5zlotr.bcs~ ~weidu_external/d5_semi_cast/d5z_end.baf~


END		//	end define function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_ACTION_FUNCTION semi_divine_spells BEGIN

// ***** check if cast spell already there... if so use same ind

ACTION_IF (FILE_EXISTS_IN_GAME ~d5zclons.2da~) BEGIN

  OUTER_SET high_ind = 99
  COPY_EXISTING ~d5zclons.2da~ ~override~
    COUNT_2DA_COLS cols
    READ_2DA_ENTRIES_NOW ~r2en_zclons~ cols
    FOR (row = 0; row < r2en_zclons; ++row) BEGIN
      READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 0 this_ind
      PATCH_IF (this_ind > high_ind) BEGIN
        SET high_ind = this_ind
      END
    END
  BUT_ONLY

  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__spheres.d5~) BEGIN
    COPY_EXISTING_REGEXP ~^[Ss][Pp][Pp][Rr][1-7]\([0-4][0-9]\|50\)\.spl$~ ~override~
		SET spl_ind = 0
        INNER_ACTION BEGIN
		  ACTION_IF (FILE_CONTAINS_EVALUATED (~d5zclons.2da~ ~%SOURCE_RES%~)) BEGIN
		    COPY_EXISTING ~d5zclons.2da~ ~override~
		      COUNT_2DA_COLS cols
	          READ_2DA_ENTRIES_NOW ~r2en_zclons~ cols
	          FOR (row = 0; row < r2en_zclons; ++row) BEGIN
	            READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 0 prev_ind
	            READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 2 cast_spell
	            PATCH_IF (~%SOURCE_RES%~ STRING_EQUAL_CASE ~%cast_spell%~) BEGIN
	              SET spl_ind = prev_ind
	            END 
	          END
	        BUT_ONLY
	      END
	      ACTION_IF (spl_ind = 0) BEGIN
	        OUTER_SET high_ind = high_ind + 1
		    OUTER_SET spl_ind = high_ind
		  END
          APPEND ~d5zclons.2da~ ~%spl_ind% 	%SOURCE_RES% 	%SOURCE_RES% 	divine 	no ~ UNLESS ~%SOURCE_RES% 	%SOURCE_RES%~
        END
    BUT_ONLY
  END	//	end no FnP

  ACTION_IF (FILE_EXISTS_IN_GAME ~d5__spheres.d5~) BEGIN
    COPY_EXISTING ~d5fnplst.2da~ ~override~
      COUNT_2DA_COLS cols
      READ_2DA_ENTRIES_NOW ~r2en_fnplst~ cols
      FOR (row = 0; row < r2en_fnplst; ++row) BEGIN
        READ_2DA_ENTRY_FORMER ~r2en_fnplst~ row 0 real_spell
        READ_2DA_ENTRY_FORMER ~r2en_fnplst~ row 1 major_spell
        READ_2DA_ENTRY_FORMER ~r2en_fnplst~ row 2 minor_spell
        READ_2DA_ENTRY_FORMER ~r2en_fnplst~ row 3 focus_spell
        SET spl_ind = 0
        INNER_ACTION BEGIN
		  COPY_EXISTING ~d5zclons.2da~ ~override~
		    COUNT_2DA_COLS cols
		    COUNT_2DA_ROWS cols rows
		    READ_2DA_ENTRY (rows - 1) 0 cols last_ind
		  BUT_ONLY
		  ACTION_IF (FILE_CONTAINS_EVALUATED (~d5zclons.2da~ ~%real_spell%~)) BEGIN
		    COPY_EXISTING ~d5zclons.2da~ ~override~
		      COUNT_2DA_COLS cols
	          READ_2DA_ENTRIES_NOW ~r2en_zclons~ cols
		      READ_2DA_ENTRY (r2en_zclons - 1) 0 cols last_ind
	          FOR (row = 0; row < r2en_zclons; ++row) BEGIN
	            READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 0 prev_ind
	            READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 2 cast_spell
	            PATCH_IF (~%real_spell%~ STRING_EQUAL_CASE ~%cast_spell%~) BEGIN
	              SET spl_ind = prev_ind
	            END 
	          END
	        BUT_ONLY
          END
	      ACTION_IF (spl_ind = 0) BEGIN
	        OUTER_SET high_ind = high_ind + 1
		    OUTER_SET spl_ind = high_ind
		  END
          APPEND ~d5zclons.2da~ ~%spl_ind% 	%major_spell%	%real_spell% 	divine 	no ~ UNLESS ~%major_spell%	%real_spell%~
//          APPEND ~d5zclons.2da~ ~%spl_ind% 	%focus_spell%	%real_spell% 	divine 	no ~ UNLESS ~%focus_spell%	%real_spell%~
          ACTION_IF !(~%minor_spell%~ STRING_EQUAL_CASE ~%major_spell%~) BEGIN
            ACTION_IF !(~%minor_spell%~ STRING_EQUAL_CASE ~****~) BEGIN
              APPEND ~d5zclons.2da~ ~%spl_ind% 	%minor_spell% 	%real_spell% 	divine 	no ~ UNLESS ~%minor_spell% 	%real_spell%~
            END
          END
        END
      END
    BUT_ONLY
  END	//	end FnP

END 

END // end function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_ACTION_FUNCTION semi_arcane_spells BEGIN

ACTION_IF (FILE_EXISTS_IN_GAME ~d5zclons.2da~) BEGIN

  OUTER_SET high_ind = 99
  COPY_EXISTING ~d5zclons.2da~ ~override~
    COUNT_2DA_COLS cols
    READ_2DA_ENTRIES_NOW ~r2en_zclons~ cols
    FOR (row = 0; row < r2en_zclons; ++row) BEGIN
      READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 0 this_ind
      PATCH_IF (this_ind > high_ind) BEGIN
        SET high_ind = this_ind
      END
    END
  BUT_ONLY

  COPY_EXISTING ~d5zclons.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
    READ_2DA_ENTRY (rows - 1) 0 cols last_ind
  BUT_ONLY

  OUTER_SET scroll_spell_ind = 0
  OUTER_SPRINT $scroll_spells(~spell~) ~0~ // ~%scroll_spell_ind%~
  COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
    READ_BYTE     0x2f current ELSE 0
    READ_BYTE     0x2b current2 ELSE 0
    READ_LONG 0x64 headoffset  ELSE 0
    READ_SHORT 0x68 headcount  ELSE 0
    READ_LONG 0x6a effectsoffset  ELSE 0
    haslearn = 0
    hascast = 0
//    PATCH_IF (headcount > 1) BEGIN
      FOR (headcyc = 0; headcyc < headcount ; headcyc = headcyc + 1) BEGIN
        thishead = 0
        READ_SHORT (headoffset + (headcyc * 0x38) + 0x1e) effcount  ELSE 0
        READ_SHORT (headoffset + (headcyc * 0x38) + 0x20) effectsindex  ELSE 0
        FOR (effcyc = 0; effcyc < effcount; effcyc = effcyc + 1) BEGIN
          READ_SHORT (effectsoffset + (effectsindex + effcyc)* 0x30) opcode ELSE 0
          PATCH_IF (opcode = 0x93) AND (thishead = 0) BEGIN
            READ_ASCII (effectsoffset + 0x14 + (effectsindex + effcyc)* 0x30) resref_learn  ELSE 0
            INNER_PATCH_FILE ~%resref_learn%.spl~ BEGIN
              READ_SHORT 0x1c type
            END
            PATCH_IF (type = 1) BEGIN // arcane spell scroll
              thishead = 1
              haslearn = 1
            END
          END 
          PATCH_IF ((opcode = 0x92) OR (opcode = 0x94)) AND (thishead = 0) BEGIN
            READ_ASCII (effectsoffset + 0x14 + (effectsindex + effcyc)* 0x30) resref_cast  ELSE 0
            INNER_PATCH_FILE ~%resref_cast%.spl~ BEGIN
              READ_SHORT 0x1c type
            END
            PATCH_IF (type = 1) BEGIN // arcane spell scroll
              thishead = 1
              hascast = 1
            END
          END 
        END 
      END 
//    END // end has >1 headers
    PATCH_IF (haslearn = 1) AND (hascast = 1) AND (~%resref_cast%~ STRING_EQUAL_CASE ~%resref_learn%~) BEGIN
      SPRINT $scroll_spells(~%resref_learn%~) ~1~ // ~%scroll_spell_ind%~
      SET ++scroll_spell_ind
    END
  BUT_ONLY

  ACTION_FOR_EACH hla IN
	~spwi920~
	~spwi921~
	~spwi922~
	~spwi923~
	~spwi924~
	~spwi925~
	~TG#DRGB~
	~TG#CLEA~
	~TG#BONU~
	~TG#DTHF~
	~TG#AEGI~
	~TG#FORS~
	~LI#SCRB~		BEGIN
	ACTION_IF (FILE_EXISTS_IN_GAME ~%hla%.spl~) BEGIN
      COPY_EXISTING ~%hla%.spl~ ~override~
	    READ_SHORT 0x1c spell_type
	    PATCH_IF (spell_type = 1) BEGIN
	      SPRINT $scroll_spells(~%hla%~) ~1~
	    END
      IF_EXISTS BUT_ONLY
    END
  END

  ACTION_PHP_EACH scroll_spells AS arcane_spell => ind BEGIN
    ACTION_IF (%ind% > 0) BEGIN
      OUTER_SET spl_ind = 0
	  ACTION_IF (FILE_CONTAINS_EVALUATED (~d5zclons.2da~ ~%arcane_spell%~)) BEGIN
		COPY_EXISTING ~d5zclons.2da~ ~override~
		  COUNT_2DA_COLS cols
	      READ_2DA_ENTRIES_NOW ~r2en_zclons~ cols
	      FOR (row = 0; row < r2en_zclons; ++row) BEGIN
	        READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 0 prev_ind
	        READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 2 cast_spell
	        PATCH_IF (~%arcane_spell%~ STRING_EQUAL_CASE ~%cast_spell%~) BEGIN
	          SET spl_ind = prev_ind
	        END 
	      END
	    BUT_ONLY
      END
      ACTION_IF (spl_ind = 0) BEGIN
        OUTER_SET high_ind = high_ind + 1
	    OUTER_SET spl_ind = high_ind
	  END
      APPEND ~d5zclons.2da~ ~%spl_ind% 	%arcane_spell% 	%arcane_spell% 	arcane 	no ~ UNLESS ~%arcane_spell% 	%arcane_spell%~
    END
  END
  
END

END // end function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_ACTION_FUNCTION add_semi_spells STR_VAR new_spell = ~x~ cast_spell = ~x~ spell_type = ~x~ BEGIN

// add them to zclons.2da

ACTION_IF (FILE_EXISTS_IN_GAME ~d5zclons.2da~) BEGIN

  COPY_EXISTING ~d5zclons.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
    READ_2DA_ENTRY (rows - 1) 0 cols last_ind
  BUT_ONLY
  OUTER_SET spl_ind = (last_ind + 1)

  APPEND ~d5zclons.2da~ ~%spl_ind% 	%new_spell% 	%cast_spell% 	%spell_type% 	no ~ UNLESS ~%new_spell% 	%cast_spell%~

END

// then just re-run the 'process spells' function
// wait no better to do that manually

//LAF process_semi_spells END

END	//	end function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_ACTION_FUNCTION free_cast_spells STR_VAR free_spell = ~~ list_spell = ~~ BEGIN

ACTION_IF (FILE_CONTAINS_EVALUATED (~d5zclons.2da~ ~%free_spell%~)) BEGIN
  ACTION_IF !(FILE_EXISTS_IN_GAME ~%list_spell%.spl~) BEGIN
    COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/%list_spell%.spl~
  END
  COPY_EXISTING ~d5zclons.2da~ ~override~
    COUNT_2DA_COLS cols
    READ_2DA_ENTRIES_NOW ~r2en_zclons~ cols
    SET free_spell_ind = 0
    FOR (row = 0; row < r2en_zclons; ++row) BEGIN
      READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 1 mem_spell
      READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 0 z_ind
      PATCH_IF (~%mem_spell%~ STRING_EQUAL_CASE ~%free_spell%~) BEGIN
        SET free_spell_ind = z_ind
      END 
    END
  BUT_ONLY  
  ACTION_IF (free_spell_ind > 0) BEGIN
    COPY_EXISTING ~%list_spell%.spl~ ~override~
 	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z%free_spell_ind%b~ END
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5z%free_spell_ind%b~ END
    BUT_ONLY
  END
END

END	//	end function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_ACTION_FUNCTION free_known_spells STR_VAR free_spell = ~~ list_spell = ~~ BEGIN

/*
ACTION_IF (FILE_CONTAINS_EVALUATED (~d5zclons.2da~ ~%free_spell%~)) BEGIN
  COPY_EXISTING ~d5zclons.2da~ ~override~
    COUNT_2DA_COLS cols
    READ_2DA_ENTRIES_NOW ~r2en_zclons~ cols
    FOR (row = 0; row < r2en_zclons; ++row) BEGIN
      READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 1 mem_spell
      READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 0 z_ind
      PATCH_IF (~%mem_spell%~ STRING_EQUAL_CASE ~%free_spell%~) BEGIN
        SET free_spell_ind = z_ind
      END
    END
  BUT_ONLY  
*/
  ACTION_IF !(FILE_EXISTS_IN_GAME ~%list_spell%.spl~) BEGIN
    COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/%list_spell%.spl~
  END
  COPY_EXISTING ~%list_spell%.spl~ ~override~
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = EVAL ~%free_spell%~ END
  BUT_ONLY
//END

END	//	end function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_ACTION_FUNCTION find_zclons_spell STR_VAR spell_to_find = ~~ RET zclons_ind spell_to_cast type_of_spell BEGIN

COPY_EXISTING ~d5zclons.2da~ ~override~
      COUNT_2DA_COLS cols
      READ_2DA_ENTRIES_NOW ~r2en_zclons~ cols
      FOR (row = 0; row < r2en_zclons; ++row) BEGIN
        READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 0 z_ind
        READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 1 mem_spell
        READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 2 cast_spell
        READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 3 spell_type
        READ_2DA_ENTRY_FORMER ~r2en_zclons~ row 4 spell_proc
        PATCH_IF (~%mem_spell%~ STRING_EQUAL_CASE ~%spell_to_find%~) BEGIN
          SET zclons_ind = %z_ind%
          SPRINT spell_to_cast ~%cast_spell%~
          SPRINT type_of_spell ~%spell_type%~
        END
      END
BUT_ONLY

END	//	end function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_PATCH_FUNCTION divine_casting_slots STR_VAR table_spl = ~~ BEGIN

// PATCH function - copy .2da table, run this

  INNER_ACTION BEGIN
    COPY ~%MOD_FOLDER%/lib/semi_spont/d5__slt.spl~ ~override/%table_spl%.spl~
  END
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW r2en_table cols
  FOR (row = 0; row < r2en_table; ++row) BEGIN
    PATCH_IF (cols > 1) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 1 level_1
    END
    PATCH_IF (cols > 2) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 2 level_2
    END
    PATCH_IF (cols > 3) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 3 level_3
    END
    PATCH_IF (cols > 4) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 4 level_4
    END
    PATCH_IF (cols > 5) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 5 level_5
    END
    PATCH_IF (cols > 6) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 6 level_6
    END
    PATCH_IF (cols > 7) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 7 level_7
    END
    INNER_ACTION BEGIN
      COPY_EXISTING ~%table_spl%.spl~ ~override~
        PATCH_IF (VARIABLE_IS_SET %level_1%) BEGIN
          PATCH_IF (IS_AN_INT %level_1%) AND (%level_1% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_1% << 4) parameter2 = (134 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_2%) BEGIN
          PATCH_IF (IS_AN_INT %level_2%) AND (%level_2% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_2% << 8) parameter2 = (134 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_3%) BEGIN
          PATCH_IF (IS_AN_INT %level_3%) AND (%level_3% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_3% << 12) parameter2 = (134 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_4%) BEGIN
          PATCH_IF (IS_AN_INT %level_4%) AND (%level_4% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_4% << 16) parameter2 = (134 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_5%) BEGIN
          PATCH_IF (IS_AN_INT %level_5%) AND (%level_5% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_5% << 20) parameter2 = (134 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_6%) BEGIN
          PATCH_IF (IS_AN_INT %level_6%) AND (%level_6% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_6% << 24) parameter2 = (134 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_7%) BEGIN
          PATCH_IF (IS_AN_INT %level_7%) AND (%level_7% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_7% << 28) parameter2 = (134 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
      IF_EXISTS BUT_ONLY
    END
  END
  INNER_ACTION BEGIN
    COPY_EXISTING ~%table_spl%.spl~ ~override~
//    LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 1 STR_VAR resource = EVAL ~%table_spl%~ END
      FOR (header = 1 ; header < 40; ++header) BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR header = (%header% + 1) insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~%table_spl%~ END
        LPF ADD_SPELL_EFFECT INT_VAR header = (%header% + 1) opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
      END
  END

END	//	end function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_PATCH_FUNCTION arcane_casting_slots STR_VAR table_spl = ~~ BEGIN

// PATCH function - copy .2da table, run this

  INNER_ACTION BEGIN
    COPY ~%MOD_FOLDER%/lib/semi_spont/d5__slt.spl~ ~override/%table_spl%.spl~
  END
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW r2en_table cols
  FOR (row = 0; row < r2en_table; ++row) BEGIN
    PATCH_IF (cols > 1) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 1 level_1
    END
    PATCH_IF (cols > 2) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 2 level_2
    END
    PATCH_IF (cols > 3) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 3 level_3
    END
    PATCH_IF (cols > 4) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 4 level_4
    END
    PATCH_IF (cols > 5) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 5 level_5
    END
    PATCH_IF (cols > 6) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 6 level_6
    END
    PATCH_IF (cols > 7) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 7 level_7
    END
    PATCH_IF (cols > 8) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 8 level_8
    END
    PATCH_IF (cols > 9) BEGIN
      READ_2DA_ENTRY_FORMER r2en_table row 9 level_9
    END
    INNER_ACTION BEGIN
      COPY_EXISTING ~%table_spl%.spl~ ~override~
        PATCH_IF (VARIABLE_IS_SET %level_1%) BEGIN
          PATCH_IF (IS_AN_INT %level_1%) AND (%level_1% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_1% << 4) parameter2 = (108 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_2%) BEGIN
          PATCH_IF (IS_AN_INT %level_2%) AND (%level_2% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_2% << 8) parameter2 = (108 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_3%) BEGIN
          PATCH_IF (IS_AN_INT %level_3%) AND (%level_3% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_3% << 12) parameter2 = (108 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_4%) BEGIN
          PATCH_IF (IS_AN_INT %level_4%) AND (%level_4% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_4% << 16) parameter2 = (108 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_5%) BEGIN
          PATCH_IF (IS_AN_INT %level_5%) AND (%level_5% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_5% << 20) parameter2 = (108 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_6%) BEGIN
          PATCH_IF (IS_AN_INT %level_6%) AND (%level_6% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_6% << 24) parameter2 = (108 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_7%) BEGIN
          PATCH_IF (IS_AN_INT %level_7%) AND (%level_7% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_7% << 28) parameter2 = (108 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_8%) BEGIN
          PATCH_IF (IS_AN_INT %level_8%) AND (%level_8% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_8% << 24) parameter2 = (109 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
        PATCH_IF (VARIABLE_IS_SET %level_9%) BEGIN
          PATCH_IF (IS_AN_INT %level_9%) AND (%level_9% > 0) BEGIN
            LPF ADD_SPELL_EFFECT INT_VAR header = (%row% + 1) opcode = 233 target = 1 parameter1 = (%level_9% << 28) parameter2 = (109 + (0x10000 * 1)) timing = 0 duration = 126144000 END
          END
        END
      IF_EXISTS BUT_ONLY
    END
  END
  INNER_ACTION BEGIN
    COPY_EXISTING ~%table_spl%.spl~ ~override~
//      LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 1 STR_VAR resource = EVAL ~%table_spl%~ END
      FOR (header = 1 ; header < 40; ++header) BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR header = (%header% + 1) insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~%table_spl%~ END
        LPF ADD_SPELL_EFFECT INT_VAR header = (%header% + 1) opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
      END
  END

END	//	end function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_ACTION_MACRO semi_int_slots BEGIN

ACTION_IF (FILE_EXISTS_IN_GAME ~5E_casting_settings.ini~) BEGIN
  	INCLUDE ~override/5E_casting_settings.ini~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~5E_casting_settings.ini~) BEGIN
  	INCLUDE ~%MOD_FOLDER%/lib/semi_spont/5E_casting_settings.ini~
END

LAM 5E_casting_settings

ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_SEMI_ARCANE~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_SEMI_ARCANE~) BEGIN
		SET semi_spont_arcane = %state_ind%
	  END
	END
  BUT_ONLY
END
ACTION_IF !(VARIABLE_IS_SET %semi_spont_arcane%) BEGIN
  LAF d5_resolve_state STR_VAR new_state_id = ~D5_SEMI_ARCANE~ RET new_state_ind END
  OUTER_SET semi_spont_arcane = %new_state_ind%
END

ACTION_DEFINE_ASSOCIATIVE_ARRAY int_nums_lets BEGIN
	13	=> 1a
	14	=> 1b
	15	=> 2a
	16	=> 2b
	17	=> 3a
	18	=> 3b
	19	=> 4a
	20	=> 4b
	21	=> 5a
	22	=> 5b
	23	=> 6a
	24	=> 6b
	25	=> 7a
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__semi_int.d5~) BEGIN

// stat-based bonus spells____________________________________________________________
//
/*
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5nabsw.spl~) BEGIN
  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5nabsw.spl~
	LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5absp1~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5absp1~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5abspw~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5abspw~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwl~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwm~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwn~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwo~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwp~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwq~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwr~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intws~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwt~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwu~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intww~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwx~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwy~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsl~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsm~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsn~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrso~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsp~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsq~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsr~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrss~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrst~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsu~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsw~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsx~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsy~ END
END
*/

ACTION_IF (int_bonus_mem_slots = 0) BEGIN
  COPY_EXISTING ~d5zzini.spl~ ~override~
//  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 1 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5nabsw~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 1 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5absp1~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 1 opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5absp1~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 1 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5abspw~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 1 opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5abspw~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 1 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5absp2~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 1 opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5absp2~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 1 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5abspb~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 1 opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5abspb~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 1 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5zislt~ END
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 1 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5zjslt~ END
END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intbz.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 42 parameter1 = (0 - 1) parameter2 = 127 target = 1 timing = 9 END

//OUTER_SET string = RESOLVE_STR_REF(~something is happening...~)

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb1a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  PATCH_IF !(MOD_IS_INSTALLED ~tomeandblood.tp2~ ~62~) BEGIN	//	L1 cantrips
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
  END
//  LPF ADD_SPELL_EFFECT INT_VAR opcode = 139 target = 1 parameter1 = %string% timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb1b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  PATCH_IF !(MOD_IS_INSTALLED ~tomeandblood.tp2~ ~62~) BEGIN	//	L1 cantrips
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
  END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb2a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb2b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb3a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb3b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb4a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb4b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb5a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb5b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb6a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb6b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5intb7a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (108 + (0x10000 * 1)) timing = 1 END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zintz.spl~
  PHP_EACH int_nums_lets AS int => slot BEGIN
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %int% parameter2 = 128 timing = 1 STR_VAR resource = EVAL ~d5intb%slot%~ END
  END
  PHP_EACH int_nums_lets AS int => slot BEGIN
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5intb%slot%~ END
  END
IF_EXISTS BUT_ONLY

COPY_EXISTING ~d5zlotf.spl~ ~override~
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 duration = 0 STR_VAR resource = ~d5zintz~ END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_marker.d5~ ~override/d5__semi_int.d5~

END

// ***** ^^ the above only needs to be done once ^^___________________________________

END		//	end define function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_ACTION_MACRO semi_cha_slots BEGIN

/*
APPEND ~splprot.2da~ ~D5_CHR_SLOTS%TAB%42%TAB%-1%TAB%1~ UNLESS ~D5_CHR_SLOTS~

COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols 
	READ_2DA_ENTRIES_NOW rows cols   
	FOR (row = 1; row < rows; ++row) BEGIN 
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~ 
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_CHR_SLOTS~ BEGIN
	    SET chr_slots = %row%
	  END
	END
BUT_ONLY
*/

ACTION_DEFINE_ASSOCIATIVE_ARRAY cha_nums_lets BEGIN
	13	=> 1a
	14	=> 1b
	15	=> 2a
	16	=> 2c
	17	=> 2b
	18	=> 3a
	19	=> 3c
	20	=> 3b
	21	=> 4a
	22	=> 4c
	23	=> 4b
	24	=> 5a
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__semi_cha.d5~) BEGIN

// stat-based bonus spells____________________________________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5nabsw.spl~) BEGIN
  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5nabsw.spl~
	LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5absp1~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5absp1~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5abspw~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5abspw~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwl~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwm~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwn~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwo~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwp~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwq~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwr~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intws~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwt~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwu~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intww~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwx~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5intwy~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsl~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsm~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsn~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrso~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsp~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsq~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsr~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrss~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrst~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsu~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsv~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsw~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsx~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5chrsy~ END
END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chasz.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 42 parameter1 = (0 - 1) parameter2 = 31 target = 1 timing = 9 END

//OUTER_SET string = RESOLVE_STR_REF(~something is happening...~)

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas1a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  PATCH_IF !(MOD_IS_INSTALLED ~tomeandblood.tp2~ ~62~) BEGIN	//	L1 cantrips
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
  END
//  LPF ADD_SPELL_EFFECT INT_VAR opcode = 139 target = 1 parameter1 = %string% timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas1b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  PATCH_IF !(MOD_IS_INSTALLED ~tomeandblood.tp2~ ~62~) BEGIN	//	L1 cantrips
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
  END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas2a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas2c.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 191 target = 1 parameter1 = 1 parameter2 = 0 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas2b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas3a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas3c.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 191 target = 1 parameter1 = 2 parameter2 = 0 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas3b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas4a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas4c.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 191 target = 1 parameter1 = 3 parameter2 = 0 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas4b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (108 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5chas5a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (108 + (0x10000 * 1)) timing = 1 END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham1a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 95 target = 1 parameter1 = 1 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham1b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 95 target = 1 parameter1 = 2 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham2a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 95 target = 1 parameter1 = 3 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham2c.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 191 target = 1 parameter1 = 1 parameter2 = 0 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham2b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 95 target = 1 parameter1 = 4 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham3a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 95 target = 1 parameter1 = 5 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham3c.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 191 target = 1 parameter1 = 2 parameter2 = 0 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham3b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 95 target = 1 parameter1 = 6 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham4a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 95 target = 1 parameter1 = 7 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham4c.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 191 target = 1 parameter1 = 3 parameter2 = 0 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham4b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 95 target = 1 parameter1 = 8 timing = 0 duration = 126144000 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5cham5a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 95 target = 1 parameter1 = 9 timing = 0 duration = 126144000 END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_marker.d5~ ~override/d5__semi_cha.d5~

END

// ***** ^^ the above only needs to be done once ^^___________________________________

END		//	end define function


//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_ACTION_MACRO semi_wis_slots BEGIN

ACTION_IF (FILE_EXISTS_IN_GAME ~5E_casting_settings.ini~) BEGIN
  	INCLUDE ~override/5E_casting_settings.ini~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~5E_casting_settings.ini~) BEGIN
  	INCLUDE ~%MOD_FOLDER%/lib/semi_spont/5E_casting_settings.ini~
END

LAM 5E_casting_settings

ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_SEMI_DIVINE~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_SEMI_DIVINE~) BEGIN
		SET semi_spont_divine = %state_ind%
	  END
	END
  BUT_ONLY
END
ACTION_IF !(VARIABLE_IS_SET %semi_spont_divine%) BEGIN
  LAF d5_resolve_state STR_VAR new_state_id = ~D5_SEMI_DIVINE~ RET new_state_ind END
  OUTER_SET semi_spont_divine = %new_state_ind%
END

ACTION_DEFINE_ASSOCIATIVE_ARRAY wis_nums_lets BEGIN
	13	=> 1a
	14	=> 1b
	15	=> 2a
	16	=> 2b
	17	=> 3a
	18	=> 3b
	19	=> 4a
	20	=> 4b
	21	=> 5a
	22	=> 5b
	23	=> 6a
	24	=> 6b
	25	=> 7a
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__semi_wis.d5~) BEGIN

// stat-based bonus spells____________________________________________________________
//

//OUTER_SET string = RESOLVE_STR_REF(~something is happening...~)

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb1a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
//  LPF ADD_SPELL_EFFECT INT_VAR opcode = 139 target = 1 parameter1 = %string% timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb1b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb2a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb2b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb3a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb3b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb4a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb4b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb5a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb5b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb6a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb6b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5wisb7a.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (134 + (0x10000 * 1)) timing = 1 END

COPY_EXISTING ~d5shfrsh.spl~ ~override~
  PHP_EACH wis_nums_lets AS wis => slot BEGIN
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %wis% parameter2 = 128 timing = 1 STR_VAR resource = EVAL ~d5wisb%slot%~ END
  END
  PHP_EACH wis_nums_lets AS wis => slot BEGIN
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5wisb%slot%~ END
  END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5zwisz.spl~
  PHP_EACH int_nums_lets AS wis => slot BEGIN
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %int% parameter2 = 128 timing = 1 STR_VAR resource = EVAL ~d5wisb%slot%~ END
  END
  PHP_EACH int_nums_lets AS wis => slot BEGIN
	LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5wisb%slot%~ END
  END
IF_EXISTS BUT_ONLY

COPY_EXISTING ~d5zlotf.spl~ ~override~
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 duration = 0 STR_VAR resource = ~d5zwisz~ END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_marker.d5~ ~override/d5__semi_wis.d5~

END

// ***** ^^ the above only needs to be done once ^^___________________________________

END		//	end define function


//__________________________________________________________________________________
//__________________________________________________________________________________


//MAKE ARCANE +SPELL SLOT ITEMS WORK_________________________________________________
//
// *****
// set all +slot items to just +1 per level for consistency
// change Evermemory: give 1x/day ability to restore all 1st-level slots
// ...(in non-IR bgee, sod, iwdee)
// ...(Wondrous Recall + 321 d5src-1)
// ...(ring08.itm)
// likewise for Kontik's ring (for 1st- and 2nd-level slots) in iwdee
// ...(ringkon.itm)
// ring of acuity needs desc patch in non-IR bgee, sod, bg2ee
// ...(ring40.itm)
// ...(REPLACE_TEXTUALLY ~2 extra~ ~1 extra~)

DEFINE_ACTION_FUNCTION arcane_spont_items BEGIN

COPY_EXISTING ~splprot.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW rows cols
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ_1_7~) BEGIN
	  SET fake_sorc_slots_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ=1_7~) BEGIN
	  SET fake_sorc_equal_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ_8_9~) BEGIN
	  SET fake_sorc_slots_8_9 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ=8_9~) BEGIN
	  SET fake_sorc_equal_8_9 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_DIV_1_7~) BEGIN
	  SET fake_sham_slots_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_DIV=1_7~) BEGIN
	  SET fake_sham_equal_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_FATIGUE_0~) BEGIN
	  SET fatigue_zero = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_PREP_SPLZ~) BEGIN
	  SET prep_spells_row = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_NOT_PREP~) BEGIN
	  SET not_prep_row = %row%
	END
  END
BUT_ONLY


//wizard +slot items__________________________________________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__arcane_slot_items.d5~) BEGIN

ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_MULTI_SORC~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_MULTI_SORC~) BEGIN
		SET multi_sorc_state = %state_ind%
	  END
	END
  BUT_ONLY
END
ACTION_IF !(VARIABLE_IS_SET %multi_sorc_state%) BEGIN
  LAF d5_resolve_state STR_VAR new_state_id = ~D5_MULTI_SORC~ RET new_state_ind END
  OUTER_SET multi_sorc_state = %new_state_ind%
END

ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_SEMI_ARCANE~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_SEMI_ARCANE~) BEGIN
		SET semi_spont_arcane = %state_ind%
	  END
	END
  BUT_ONLY
END
ACTION_IF !(VARIABLE_IS_SET %semi_spont_arcane%) BEGIN
  LAF d5_resolve_state STR_VAR new_state_id = ~D5_SEMI_ARCANE~ RET new_state_ind END
  OUTER_SET semi_spont_arcane = %new_state_ind%
END

ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_SEMI_DIVINE~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_SEMI_DIVINE~) BEGIN
		SET semi_spont_divine = %state_ind%
	  END
	END
  BUT_ONLY
END
ACTION_IF !(VARIABLE_IS_SET %semi_spont_divine%) BEGIN
  LAF d5_resolve_state STR_VAR new_state_id = ~D5_SEMI_DIVINE~ RET new_state_ind END
  OUTER_SET semi_spont_divine = %new_state_ind%
END

OUTER_SET generic_ind = 1
OUTER_SET mageslot_item_ind = 1
OUTER_TEXT_SPRINT $mage_slot_items(~0~ ~0~ ~0~ ~0~) ~item~
COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ override
  SET slot_item = 0
  PATCH_IF SOURCE_SIZE > 0x72 BEGIN
    GET_OFFSET_ARRAY glob_fx ITM_V10_GEN_EFFECTS
    PHP_EACH glob_fx AS idx => off BEGIN
      PATCH_IF SHORT_AT off == 42 BEGIN
        SET slot_item = 1
        READ_LONG off + 0x04 param1 ELSE 0
        READ_LONG off + 0x08 param2 ELSE 0
        FOR (spell_level = 1; spell_level < 10; ++spell_level) BEGIN
          PATCH_IF param2 & (2 ** (spell_level - 1)) BEGIN
            TEXT_SPRINT $mage_slot_items(~%generic_ind%~ ~%mageslot_item_ind%~ ~%spell_level%~ ~%param1%~) ~%SOURCE_RES%~
            SET ++generic_ind
          END
        END
        PATCH_IF param2 == 0 BEGIN
          TEXT_SPRINT $mage_slot_items(~%generic_ind%~ ~%mageslot_item_ind%~ ~%param1%~ ~99~) ~%SOURCE_RES%~
          SET ++generic_ind
        END
      END // ELSE
      PATCH_IF SHORT_AT off == 177 /* || SHORT_AT off == 326 */ BEGIN
        READ_ASCII off + 0x14 eff_res (8) NULL
        INNER_PATCH_FILE ~%eff_res%.EFF~ BEGIN
          PATCH_IF LONG_AT 0x010 == 42 BEGIN
            SET slot_item = 1
            READ_LONG 0x1c param1 ELSE 0
            READ_LONG 0x20 param2 ELSE 0
            FOR (spell_level = 1; spell_level < 10; ++spell_level) BEGIN
              PATCH_IF param2 & (2 ** (spell_level - 1)) BEGIN
                TEXT_SPRINT $mage_slot_items(~%generic_ind%~ ~%mageslot_item_ind%~ ~%spell_level%~ ~%param1%~) ~%SOURCE_RES%~
                SET ++generic_ind
              END
            END
            PATCH_IF param2 == 0 BEGIN
              TEXT_SPRINT $mage_slot_items(~%generic_ind%~ ~%mageslot_item_ind%~ ~%param1%~ ~99~) ~%SOURCE_RES%~
              SET ++generic_ind
            END
          END
        END
      END
    END
  END
  PATCH_IF slot_item = 1 BEGIN
    SET ++mageslot_item_ind
  END
BUT_ONLY
	  
/*
ACTION_PHP_EACH mage_slot_items AS ind => slot_item BEGIN
  PRINT ~%ind% %ind_1% %ind_2% %ind_3% %slot_item%~
END
*/

ACTION_PHP_EACH mage_slot_items AS ind => slot_item BEGIN
 ACTION_IF (%ind% > 0) BEGIN
  PRINT ~%ind% %ind_1% %ind_2% %ind_3% %slot_item%~
  ACTION_IF (%ind_3% < 99) BEGIN
	ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z#%ind_1%%ind_2%.spl~) BEGIN
	  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z#%ind_1%%ind_2%.spl~
		LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		PATCH_IF (%ind_2% = 1) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 2) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 3) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 4) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 5) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 6) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 7) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 8) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (109 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 9) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (109 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%%ind_2%~ END
		LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	END
	ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z_%ind_1%%ind_2%.spl~) BEGIN
	  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z_%ind_1%%ind_2%.spl~
		LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z#%ind_1%%ind_2%~ END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5ssplz~ END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	END
//	COPY_EXISTING ~d5b_000.spl~ ~override~
//	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
//	IF_EXISTS BUT_ONLY
	COPY_EXISTING ~d5zlots.spl~ ~override~
				~d5sslot.spl~ ~override~
	  PATCH_IF (%ind_2% = 1) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 4) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 2) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 8) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 3) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 12) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 4) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 16) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 5) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 20) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 6) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 24) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 7) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 28) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 8) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 24) parameter2 = %fake_sorc_equal_8_9% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 9) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 28) parameter2 = %fake_sorc_equal_8_9% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	  END
	IF_EXISTS BUT_ONLY
	COPY_EXISTING ~%slot_item%.itm~ ~override~
	  LPF ALTER_EFFECT INT_VAR match_opcode = 42 parameter1 = 1 END
//	  LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%%ind_2%~ END
	  LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%%ind_2%~ END
	  LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%%ind_2%~ END
//	  LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z#%ind_1%%ind_2%~ END
	  LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	  LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z_%ind_1%%ind_2%~ END
	IF_EXISTS BUT_ONLY
  END	//	end if not spell-doubling
  ACTION_IF (%ind_3% = 99) BEGIN
    ACTION_IF (~%slot_item%~ STRING_EQUAL_CASE ~ring08~) BEGIN
      COPY ~%MOD_FOLDER%/lib/semi_spont/ring08.itm~ ~override~
        SAY NAME2 ~Ring of Wizardry: Evermemory~
        SAY IDENTIFIED_DESC ~Ring of Wizardry: Evermemory
Long ago, a grand wizard from Amn was rumored to have defied Mystra's limitations on the magical arts. Legends spoke of this wizard being able to cast spells without the limitation of memorization. In the end, it was found that his powers stemmed from the several magical rings that he had made for himself. His proclaimed "everlasting memory" was a hoax, though his rings continue to be one of the most sought-after items in the realms.

STATISTICS:

Equipped abilities:
– Once per day, can refresh all 1st-level wizard spells

Weight: 0~
    END
    ACTION_IF (~%slot_item%~ STRING_EQUAL_CASE ~ringkon~) BEGIN
      COPY ~%MOD_FOLDER%/lib/semi_spont/ringkon.itm~ ~override~
        SAY NAME2 ~Kontik's Ring of Wizardry~
        SAY IDENTIFIED_DESC ~Kontik, a powerful wizard in the service of Auril, claimed this ring from a defeated enemy wizard, Nill the Infernal. An archmage who specialized in fire magic, Nill created the ring over a period of five years. The powerful item aided Nill in his far-ranging travels. Unfortunately for Nill, it did not protect him from Kontik's powerful minions and spells. It is constructed of an extremely unusual grayish-white metal called tungsten.

STATISTICS:

Equipped abilities:
– Once per day, can refresh all 1st- and 2nd-level wizard spells

Combat abilities:
– All cold damage inflicted by the character is increased by 15%

Weight: 0~
    END
	ACTION_IF (%ind_2% > 0) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z#%ind_1%1.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z#%ind_1%1.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%1~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%1~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z_%ind_1%1.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z_%ind_1%1.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z#%ind_1%1~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5ssplz~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%1~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
	  				~d5sslot.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 4) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%1~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 42 match_parameter2 = 0 parameter1 = 1 parameter2 = 1 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%1~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%1~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%1~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%1~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z_%ind_1%1~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 1) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z#%ind_1%2.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z#%ind_1%2.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%2~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%2~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z_%ind_1%2.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z_%ind_1%2.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z#%ind_1%2~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5ssplz~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%2~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
	  				~d5sslot.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 8) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%2~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 42 match_parameter2 = 0 parameter1 = 1 parameter2 = 2 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%2~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%2~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%2~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%2~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z_%ind_1%2~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 2) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z#%ind_1%3.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z#%ind_1%3.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%3~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%3~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z_%ind_1%3.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z_%ind_1%3.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z#%ind_1%3~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5ssplz~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%3~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
	  				~d5sslot.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 12) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%3~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 42 match_parameter2 = 0 parameter1 = 1 parameter2 = 4 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%3~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%3~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%3~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%3~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z_%ind_1%3~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 3) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z#%ind_1%4.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z#%ind_1%4.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%4~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%4~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z_%ind_1%4.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z_%ind_1%4.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z#%ind_1%4~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5ssplz~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%4~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
	  				~d5sslot.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 16) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%4~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 42 match_parameter2 = 0 parameter1 = 1 parameter2 = 8 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%4~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%4~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%4~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%4~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z_%ind_1%4~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 4) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z#%ind_1%5.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z#%ind_1%5.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%5~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%5~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z_%ind_1%5.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z_%ind_1%5.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z#%ind_1%5~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5ssplz~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%5~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
	  				~d5sslot.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 20) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%5~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 42 match_parameter2 = 0 parameter1 = 1 parameter2 = 16 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%5~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%5~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%5~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%5~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z_%ind_1%5~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 5) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z#%ind_1%6.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z#%ind_1%6.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%6~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%6~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z_%ind_1%6.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z_%ind_1%6.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z#%ind_1%6~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5ssplz~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%6~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
	  				~d5sslot.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 24) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%6~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 42 match_parameter2 = 0 parameter1 = 1 parameter2 = 32 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%6~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%6~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%6~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%6~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z_%ind_1%6~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 6) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z#%ind_1%7.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z#%ind_1%7.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (108 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%7~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%7~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z_%ind_1%7.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z_%ind_1%7.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z#%ind_1%7~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5ssplz~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%7~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
	  				~d5sslot.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 28) parameter2 = %fake_sorc_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%7~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 42 match_parameter2 = 0 parameter1 = 1 parameter2 = 64 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%7~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%7~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%7~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%7~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z_%ind_1%7~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 7) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z#%ind_1%8.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z#%ind_1%8.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (109 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%8~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%8~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z_%ind_1%8.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z_%ind_1%8.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z#%ind_1%8~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5ssplz~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%8~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
	  				~d5sslot.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 24) parameter2 = %fake_sorc_equal_8_9% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%8~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 42 match_parameter2 = 0 parameter1 = 1 parameter2 = 128 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%8~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%8~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%8~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%8~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z_%ind_1%8~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 8) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z#%ind_1%9.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z#%ind_1%9.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (109 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%9~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%9~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z_%ind_1%9.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z_%ind_1%9.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z#%ind_1%9~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5ssplz~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%9~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
	  				~d5sslot.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 28) parameter2 = %fake_sorc_equal_8_9% timing = 1 STR_VAR resource = EVAL ~d5z_%ind_1%9~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 42 match_parameter2 = 0 parameter1 = 1 parameter2 = 256 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%9~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%9~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z#%ind_1%9~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z_%ind_1%9~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z_%ind_1%9~ END
	  IF_EXISTS BUT_ONLY
	END
	COPY_EXISTING ~%slot_item%.itm~ ~override~
	  LPF DELETE_EFFECT INT_VAR match_opcode = 42 match_parameter2 = 0 END
	IF_EXISTS BUT_ONLY
  END	//	end if spell-doubling
  COPY_EXISTING ~%slot_item%.itm~ ~override~
//	LPF DELETE_EFFECT INT_VAR match_opcode = 321 STR_VAR resource = ~d5z_000~ END
//	LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5z_000~ END
	LPF DELETE_EFFECT INT_VAR match_opcode = 326 STR_VAR match_resource = ~d5zz172~ END
	LPF DELETE_EFFECT INT_VAR match_opcode = 326 STR_VAR match_resource = ~d5zspld~ END
	LPF DELETE_EFFECT INT_VAR match_opcode = 326 STR_VAR match_resource = ~d5zspla~ END
	LPF DELETE_EFFECT INT_VAR match_opcode = 326 STR_VAR match_resource = ~d5ssplz~ END
//	LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = (0 - 1) opcode = 146 target = 1 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5zsplz~ END
	LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = (0 - 1) opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 1 duration = 0 STR_VAR resource = ~d5zz172~ END
	LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = (0 - 1) opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
	LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = (0 - 1) opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
	LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = (0 - 1) opcode = 326 target = 1 parameter1 = %multi_sorc_state% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5ssplz~ END
  IF_EXISTS BUT_ONLY
 END
END

COPY ~%MOD_FOLDER%/lib/semi_spont/d5_marker.d5~ ~override/d5__arcane_slot_items.d5~

END

END		//	end define function


//__________________________________________________________________________________
//__________________________________________________________________________________


//MAKE DIVINE +SPELL SLOT ITEMS WORK_________________________________________________
//
DEFINE_ACTION_FUNCTION divine_spont_items BEGIN

COPY_EXISTING ~splprot.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW rows cols
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ_1_7~) BEGIN
	  SET fake_sorc_slots_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ=1_7~) BEGIN
	  SET fake_sorc_equal_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ_8_9~) BEGIN
	  SET fake_sorc_slots_8_9 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_WIZ=8_9~) BEGIN
	  SET fake_sorc_equal_8_9 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_DIV_1_7~) BEGIN
	  SET fake_sham_slots_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_DIV=1_7~) BEGIN
	  SET fake_sham_equal_1_7 = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_FATIGUE_0~) BEGIN
	  SET fatigue_zero = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_PREP_SPLZ~) BEGIN
	  SET prep_spells_row = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_NOT_PREP~) BEGIN
	  SET not_prep_row = %row%
	END
  END
BUT_ONLY


//priest +slot items__________________________________________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__divine_slot_items.d5~) BEGIN

ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_SEMI_DIVINE~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_SEMI_DIVINE~) BEGIN
		SET semi_spont_divine = %state_ind%
	  END
	END
  BUT_ONLY
END
ACTION_IF !(VARIABLE_IS_SET %semi_spont_divine%) BEGIN
  LAF d5_resolve_state STR_VAR new_state_id = ~D5_SEMI_DIVINE~ RET new_state_ind END
  OUTER_SET semi_spont_divine = %new_state_ind%
END

ACTION_IF (FILE_CONTAINS_EVALUATED (~splstate.ids~ ~D5_SEMI_ARCANE~)) BEGIN
  COPY_EXISTING ~splstate.ids~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 1 ~state_name~
	  READ_2DA_ENTRY_FORMER rows row 0 ~state_ind~
	  PATCH_IF (~%state_name%~ STRING_EQUAL_CASE ~D5_SEMI_ARCANE~) BEGIN
		SET semi_spont_arcane = %state_ind%
	  END
	END
  BUT_ONLY
END
ACTION_IF !(VARIABLE_IS_SET %semi_spont_arcane%) BEGIN
  LAF d5_resolve_state STR_VAR new_state_id = ~D5_SEMI_ARCANE~ RET new_state_ind END
  OUTER_SET semi_spont_arcane = %new_state_ind%
END

OUTER_SET generic_ind = 1
OUTER_SET priestslot_item_ind = 1
OUTER_TEXT_SPRINT $priest_slot_items(~0~ ~0~ ~0~ ~0~) ~item~
COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ override
  SET slot_item = 0
  PATCH_IF SOURCE_SIZE > 0x72 BEGIN
    GET_OFFSET_ARRAY glob_fx ITM_V10_GEN_EFFECTS
    PHP_EACH glob_fx AS idx => off BEGIN
      PATCH_IF SHORT_AT off == 62 BEGIN
        SET slot_item = 1
        READ_LONG off + 0x04 param1 ELSE 0
        READ_LONG off + 0x08 param2 ELSE 0
        FOR (spell_level = 1; spell_level < 8; ++spell_level) BEGIN
          PATCH_IF param2 & (2 ** (spell_level - 1)) BEGIN
            TEXT_SPRINT $priest_slot_items(~%generic_ind%~ ~%priestslot_item_ind%~ ~%spell_level%~ ~%param1%~) ~%SOURCE_RES%~
            SET ++generic_ind
          END
        END
        PATCH_IF param2 == 0 BEGIN
          TEXT_SPRINT $priest_slot_items(~%generic_ind%~ ~%priestslot_item_ind%~ ~%param1%~ ~99~) ~%SOURCE_RES%~
          SET ++generic_ind
        END
      END // ELSE
      PATCH_IF SHORT_AT off == 177 /* || SHORT_AT off == 326 */ BEGIN
        READ_ASCII off + 0x14 eff_res (8) NULL
        INNER_PATCH_FILE ~%eff_res%.EFF~ BEGIN
          PATCH_IF LONG_AT 0x010 == 62 BEGIN
            SET slot_item = 1
            READ_LONG 0x1c param1 ELSE 0
            READ_LONG 0x20 param2 ELSE 0
            FOR (spell_level = 1; spell_level < 8; ++spell_level) BEGIN
              PATCH_IF param2 & (2 ** (spell_level - 1)) BEGIN
                TEXT_SPRINT $priest_slot_items(~%generic_ind%~ ~%priestslot_item_ind%~ ~%spell_level%~ ~%param1%~) ~%SOURCE_RES%~
                SET ++generic_ind
              END
            END
            PATCH_IF param2 == 0 BEGIN
              TEXT_SPRINT $priest_slot_items(~%generic_ind%~ ~%priestslot_item_ind%~ ~%param1%~ ~99~) ~%SOURCE_RES%~
              SET ++generic_ind
            END
          END
        END
      END
    END
  END
  PATCH_IF slot_item = 1 BEGIN
    SET ++priestslot_item_ind
  END
BUT_ONLY

ACTION_PHP_EACH priest_slot_items AS ind => slot_item BEGIN
 ACTION_IF (%ind% > 0) BEGIN
  PRINT ~%ind% %ind_1% %ind_2% %ind_3% %slot_item%~
  ACTION_IF (%ind_3% < 99) BEGIN
	ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z!%ind_1%%ind_2%.spl~) BEGIN
	  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z!%ind_1%%ind_2%.spl~
		LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		PATCH_IF (%ind_2% = 1) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 2) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 3) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 4) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 5) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 6) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		PATCH_IF (%ind_2% = 7) BEGIN
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%%ind_2%~ END
		LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	END
	ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z-%ind_1%%ind_2%.spl~) BEGIN
	  COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z-%ind_1%%ind_2%.spl~
		LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z!%ind_1%%ind_2%~ END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	END
//	COPY_EXISTING ~d5b_000.spl~ ~override~
//	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
//	IF_EXISTS BUT_ONLY
	COPY_EXISTING ~d5zlots.spl~ ~override~
	  PATCH_IF (%ind_2% = 1) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 4) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 2) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 8) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 3) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 12) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 4) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 16) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 5) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 20) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 6) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 24) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 7) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 28) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 8) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 24) parameter2 = %fake_sham_equal_8_9% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	  END
	  PATCH_IF (%ind_2% = 9) BEGIN
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 28) parameter2 = %fake_sham_equal_8_9% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	  END
	IF_EXISTS BUT_ONLY
	COPY_EXISTING ~%slot_item%.itm~ ~override~
	  LPF ALTER_EFFECT INT_VAR match_opcode = 62 parameter1 = 1 END
//	  LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%%ind_2%~ END
	  LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%%ind_2%~ END
//	  LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z!%ind_1%%ind_2%~ END
	  LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	  LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z-%ind_1%%ind_2%~ END
	IF_EXISTS BUT_ONLY
  END	//	end if not spell-doubling
  ACTION_IF (%ind_3% = 99) BEGIN
	ACTION_IF (%ind_2% > 0) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z!%ind_1%1.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z!%ind_1%1.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%1~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%1~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z-%ind_1%1.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z-%ind_1%1.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z!%ind_1%1~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%1~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 4) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%1~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 62 match_parameter2 = 0 parameter1 = 1 parameter2 = 1 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%1~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%1~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%1~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z-%ind_1%1~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 1) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z!%ind_1%2.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z!%ind_1%2.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%2~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%2~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z-%ind_1%2.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z-%ind_1%2.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z!%ind_1%2~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%2~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 8) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%2~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 62 match_parameter2 = 0 parameter1 = 1 parameter2 = 2 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%2~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%2~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%2~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z-%ind_1%2~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 2) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z!%ind_1%3.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z!%ind_1%3.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%3~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%3~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z-%ind_1%3.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z-%ind_1%3.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z!%ind_1%3~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%3~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 12) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%3~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 62 match_parameter2 = 0 parameter1 = 1 parameter2 = 4 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%3~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%3~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%3~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z-%ind_1%3~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 3) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z!%ind_1%4.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z!%ind_1%4.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%4~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%4~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z-%ind_1%4.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z-%ind_1%4.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z!%ind_1%4~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%4~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 16) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%4~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 62 match_parameter2 = 0 parameter1 = 1 parameter2 = 8 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%4~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%4~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%4~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z-%ind_1%4~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 4) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z!%ind_1%5.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z!%ind_1%5.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%5~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%5~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z-%ind_1%5.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z-%ind_1%5.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z!%ind_1%5~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%5~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 20) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%5~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 62 match_parameter2 = 0 parameter1 = 1 parameter2 = 16 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%5~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%5~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%5~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z-%ind_1%5~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 5) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z!%ind_1%6.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z!%ind_1%6.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%6~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%6~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z-%ind_1%6.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z-%ind_1%6.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z!%ind_1%6~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%6~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 24) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%6~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 62 match_parameter2 = 0 parameter1 = 1 parameter2 = 32 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%6~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%6~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%6~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z-%ind_1%6~ END
	  IF_EXISTS BUT_ONLY
	END
	ACTION_IF (%ind_2% > 6) BEGIN
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z!%ind_1%7.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z!%ind_1%7.spl~
		  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (134 + (0x10000 * 1)) timing = 1 duration = 0 END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%7~ END
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%7~ END
	  END
	  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5z-%ind_1%7.spl~) BEGIN
		COPY ~%MOD_FOLDER%/lib/semi_spont/d5_base.spl~ ~override/d5z-%ind_1%7.spl~
		  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z!%ind_1%7~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %semi_spont_arcane% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspla~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%7~ END
	  END
	  COPY_EXISTING ~d5zlots.spl~ ~override~
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (15 << 28) parameter2 = %fake_sham_equal_1_7% timing = 1 STR_VAR resource = EVAL ~d5z-%ind_1%7~ END
	  IF_EXISTS BUT_ONLY
	  COPY_EXISTING ~%slot_item%.itm~ ~override~
		LPF CLONE_EFFECT INT_VAR match_opcode = 62 match_parameter2 = 0 parameter1 = 1 parameter2 = 64 END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%7~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 1 STR_VAR resource = EVAL ~d5z!%ind_1%7~ END
//		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~d5z-%ind_1%7~ END
		LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = EVAL ~d5z-%ind_1%7~ END
	  IF_EXISTS BUT_ONLY
	END
	COPY_EXISTING ~%slot_item%.itm~ ~override~
	  LPF DELETE_EFFECT INT_VAR match_opcode = 62 match_parameter2 = 0 END
	IF_EXISTS BUT_ONLY
  END	//	end if spell-doubling
  COPY_EXISTING ~%slot_item%.itm~ ~override~
//	LPF DELETE_EFFECT INT_VAR match_opcode = 321 STR_VAR resource = ~d5b_000~ END
//	LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5b_000~ END
	LPF DELETE_EFFECT INT_VAR match_opcode = 326 STR_VAR match_resource = ~d5zz172~ END
	LPF DELETE_EFFECT INT_VAR match_opcode = 326 STR_VAR match_resource = ~d5zspld~ END
	LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = (0 - 1) opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zz172~ END
	LPF ADD_ITEM_EQEFFECT INT_VAR insert_point = (0 - 1) opcode = 326 target = 1 parameter1 = %semi_spont_divine% parameter2 = 110 timing = 4 duration = 1 STR_VAR resource = ~d5zspld~ END
  IF_EXISTS BUT_ONLY
 END
END


COPY ~%MOD_FOLDER%/lib/semi_spont/d5_marker.d5~ ~override/d5__divine_slot_items.d5~

END

END		//	end define function


